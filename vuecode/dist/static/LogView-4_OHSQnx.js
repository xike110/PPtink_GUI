import{l as W,r as Z,i as ee,s as H,b as c,p as se,c as te,d as $,e as z,t as ae,g as le,f as oe}from"./webdemo-hVV6TCrw.js";/* empty css                    */import{M as ne,r as T,w as A,c as M,s as u,o as re,an as i,aw as ie,au as ce,b as E,x as P,e as r,d as m,f as w,A as _,u as d,C as ue,y as O,F as ve,l as ge,p as de,t as V,ax as pe,ay as fe,az as me,_ as he}from"./zh-cn-C3gtzjIZ.js";const we={class:"macos-window"},_e={class:"content-area"},ye={class:"section-container"},Se={class:"section-header"},be={class:"header-buttons"},xe={class:"section-content"},Te={class:"log-area"},Le=["onClick"],ke={class:"log-time"},Ce={class:"log-level"},He=["innerHTML"],$e={class:"progress-container"},Ee={class:"control-buttons"},q=1e3,R=24,Pe=ne({__name:"LogView",setup(Re){const v=W,S=ee,L=te,b=se,l=T(null);A(v,e=>{e.length>q&&ae(q),y()},{deep:!0});const p=T(0),x=T(0),n=T([]),I=()=>{if(v.value.length>n.value.length){const e=Array(v.value.length-n.value.length).fill(R);n.value=[...n.value,...e],u(()=>{const s=document.querySelectorAll(".log-line"),t=n.value.length-e.length;for(let a=0;a<e.length&&t+a<s.length;a++){const o=s[t+a];o&&(n.value[t+a]=o.offsetHeight)}})}};A(v,()=>{I()},{immediate:!0});const B=M(()=>(I(),n.value.reduce((e,s)=>e+s,0))),J=e=>{l.value&&(p.value=l.value.scrollTop,x.value=l.value.clientHeight,u(()=>{f()}))},f=()=>{const e=document.querySelectorAll(".log-line");if(e.length===0)return;let s=!1;k.value.forEach(t=>{const a=t.id,o=e[t.id-k.value[0].id];if(o&&a<n.value.length){const g=o.offsetHeight;g>0&&g!==n.value[a]&&(n.value[a]=g,s=!0)}}),s&&u(()=>{const t=n.value.reduce((a,o)=>a+o,0);if(l.value){const a=l.value.querySelector(".virtual-list-viewport");a&&(a.style.height=`${t}px`)}})},k=M(()=>{if(!l.value)return[];const e=[];let s=0;for(const o of n.value)e.push(s),s+=o;let t=0;for(;t<e.length&&e[t]+n.value[t]<p.value-R;)t++;let a=t;for(;a<e.length&&e[a]<p.value+x.value+R*2;)a++;return t=Math.max(0,t),a=Math.min(v.value.length-1,a),u(()=>{f()}),v.value.slice(t,a+1).map((o,g)=>({...o,id:t+g,offsetY:e[t+g]}))}),y=()=>{u(()=>{l.value&&setTimeout(()=>{l.value&&(l.value.scrollTop=l.value.scrollHeight)},10)})};let h=null;re(()=>{if(l.value&&(x.value=l.value.clientHeight),h=new ResizeObserver(()=>{l.value&&(x.value=l.value.clientHeight),u(()=>{f()})}),l.value&&h.observe(l.value),y(),u(()=>{f()}),document.addEventListener("visibilitychange",N),Z.value&&!S.value&&(S.value=!0),H.value&&(console.log(S.value),H.value)){let e={};try{const s=sessionStorage.getItem("runParams");if(s){const t=JSON.parse(s);t.menuName&&t.formData?(e=t,c(`已加载菜单【${t.menuName}】的参数，准备执行...`)):(e=t,c("已加载参数，准备执行...")),b.value="",L.value=0,$(),C(),n.value=[],p.value=0,u(()=>{if(l.value){const a=l.value.querySelector(".virtual-list-viewport");a&&(a.style.height="0px"),f()}}),pywebview.api.RunArgs(e),i.success("启动运行"),H.value=!1,z(!0)}}catch(s){c(`解析参数出错: ${s}`,"error")}}});const N=()=>{document.visibilityState==="visible"&&y()};ie(()=>{y()}),ce(()=>{h&&(l.value&&h.unobserve(l.value),h.disconnect(),h=null),document.removeEventListener("visibilitychange",N)});const D=async()=>{if(await le()){i.warning("请先停止运行！");return}else i.success("重新运行！"),b.value="",L.value=0,$(),C(),n.value=[],p.value=0,u(()=>{if(l.value){const t=l.value.querySelector(".virtual-list-viewport");t&&(t.style.height="0px"),f()}}),c("开始执行任务...");let s={};try{const t=sessionStorage.getItem("runParams");t?(s=JSON.parse(t),c("已加载参数，准备执行...")):c("未找到参数，将使用默认设置","warning")}catch(t){c(`解析参数出错: ${t}`,"error")}try{await pywebview.api.RunArgs(s)}catch{}},C=()=>{u(()=>{l.value&&setTimeout(()=>{l.value&&(l.value.scrollTop=0,p.value=0)},10)})},Y=async()=>{try{c("用户手动停止任务","warning"),await z(!1),F(!1),i.warning("已停止运行")}catch(e){c(`停止任务出错: ${e}`,"error")}},F=async(e,s)=>{S.value=!1,b.value="exception",y()},G=()=>{$(),C(),n.value=[],p.value=0,u(()=>{if(l.value){const e=l.value.querySelector(".virtual-list-viewport");e&&(e.style.height="0px"),f()}})},U=()=>{const e=oe();e.success?i.success("日志导出成功"):(i.error("日志导出失败"),console.error("导出日志失败:",e.error))},X=()=>{try{const e=sessionStorage.getItem("runParams");if(e){const s=JSON.parse(e);i.success("已保存当前参数到开机启动"),pywebview.api.SaveParamsToStartup(s)}else c("未找到可保存的参数","warning"),i.warning("未找到可保存的参数")}catch(e){c(`保存参数失败: ${e}`,"error"),i.error("保存参数失败")}},j=()=>{try{const e=sessionStorage.getItem("runParams");if(e){const s=JSON.parse(e);i.success("已保存当前参数到定时任务"),pywebview.api.SaveParamsToTimed(s)}else c("未找到可保存的参数","warning"),i.warning("未找到可保存的参数")}catch(e){c(`保存参数失败: ${e}`,"error"),i.error("保存参数失败")}},K=e=>{const s=/(https?:\/\/[^\s]+)/g;return e.replace(s,t=>`<a href="${t}" target="_blank" class="log-link" onclick="event.stopPropagation()">${t}</a>`)},Q=(e,s)=>{var a;if((a=s==null?void 0:s.target)!=null&&a.classList.contains("log-link"))return;const t=e.message;navigator.clipboard.writeText(t).then(()=>{i.success("已复制到剪贴板")}).catch(()=>{i.error("复制失败")})};return(e,s)=>{const t=ue,a=pe;return P(),E("div",we,[r("div",_e,[r("div",ye,[r("div",Se,[s[4]||(s[4]=r("h2",null,"运行日志",-1)),r("div",be,[m(t,{type:"danger",size:"small",onClick:j,disabled:d(v).length===0},{default:w(()=>s[0]||(s[0]=[_(" 定时执行 ")])),_:1},8,["disabled"]),m(t,{type:"primary",size:"small",onClick:X,disabled:d(v).length===0},{default:w(()=>s[1]||(s[1]=[_(" 开机启动 ")])),_:1},8,["disabled"]),m(t,{type:"warning",size:"small",onClick:G,disabled:d(v).length===0},{default:w(()=>s[2]||(s[2]=[_(" 清空日志 ")])),_:1},8,["disabled"]),m(t,{type:"success",size:"small",onClick:U,disabled:d(v).length===0},{default:w(()=>s[3]||(s[3]=[_(" 导出日志 ")])),_:1},8,["disabled"])])]),r("div",xe,[r("div",Te,[r("div",{class:"log-content",ref_key:"logContentRef",ref:l,onScroll:J},[r("div",{class:"virtual-list-viewport",style:O({height:B.value+"px"})},[(P(!0),E(ve,null,ge(k.value,o=>(P(),E("p",{key:o.id,class:de([`log-${o.type}`,"log-line"]),onClick:g=>Q(o,g),title:"点击复制",style:O({transform:`translateY(${o.offsetY}px)`})},[r("span",ke,"["+V(o.time)+"]",1),r("span",Ce,"["+V(o.type.toUpperCase())+"]",1),r("span",{class:"log-message",innerHTML:K(o.message)},null,8,He)],14,Le))),128))],4)],544)]),s[7]||(s[7]=r("div",{class:"macos-divider"},null,-1)),r("div",$e,[m(a,{"text-inside":!0,"stroke-width":26,percentage:d(L),status:d(b)},null,8,["percentage","status"])]),r("div",Ee,[m(t,{type:"success",icon:d(fe),onClick:D,plain:""},{default:w(()=>s[5]||(s[5]=[_(" 重新运行 ")])),_:1},8,["icon"]),m(t,{type:"danger",icon:d(me),onClick:Y,plain:""},{default:w(()=>s[6]||(s[6]=[_(" 停止运行 ")])),_:1},8,["icon"])])])])])])}}}),Ae=he(Pe,[["__scopeId","data-v-99198d24"]]);export{Ae as default};
