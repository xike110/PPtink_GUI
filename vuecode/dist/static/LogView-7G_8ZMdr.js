import{R as Z,r as L,w as M,D as z,T as K,N as u,o as ee,G as se,U as te,Q as H,V as c,W as ae,X as le,Y as $,M as i,Z as A,$ as oe,I as ne,c as E,d as r,g as h,h as w,S as d,j as re,L as V,F as ie,k as ce,a0 as ue,a1 as ve,a2 as ge,i as _,s as de,t as O,b as P,a3 as pe,H as fe,a4 as he,_ as me}from"./webdemo-tN3KLTAk.js";/* empty css                    */const we={class:"macos-window"},_e={class:"content-area"},ye={class:"section-container"},Se={class:"section-header"},be={class:"header-buttons"},Te={class:"section-content"},Le={class:"log-area"},xe=["onClick"],ke={class:"log-time"},Ce={class:"log-level"},He=["innerHTML"],$e={class:"progress-container"},Ee={class:"control-buttons"},q=1e3,R=24,Pe=Z({__name:"LogView",setup(Re){const v=K,S=te,x=le,b=ae,l=L(null);M(v,e=>{e.length>q&&pe(q),y()},{deep:!0});const p=L(0),T=L(0),n=L([]),I=()=>{if(v.value.length>n.value.length){const e=Array(v.value.length-n.value.length).fill(R);n.value=[...n.value,...e],u(()=>{const s=document.querySelectorAll(".log-line"),t=n.value.length-e.length;for(let a=0;a<e.length&&t+a<s.length;a++){const o=s[t+a];o&&(n.value[t+a]=o.offsetHeight)}})}};M(v,()=>{I()},{immediate:!0});const B=z(()=>(I(),n.value.reduce((e,s)=>e+s,0))),D=e=>{l.value&&(p.value=l.value.scrollTop,T.value=l.value.clientHeight,u(()=>{f()}))},f=()=>{const e=document.querySelectorAll(".log-line");if(e.length===0)return;let s=!1;k.value.forEach(t=>{const a=t.id,o=e[t.id-k.value[0].id];if(o&&a<n.value.length){const g=o.offsetHeight;g>0&&g!==n.value[a]&&(n.value[a]=g,s=!0)}}),s&&u(()=>{const t=n.value.reduce((a,o)=>a+o,0);if(l.value){const a=l.value.querySelector(".virtual-list-viewport");a&&(a.style.height=`${t}px`)}})},k=z(()=>{if(!l.value)return[];const e=[];let s=0;for(const o of n.value)e.push(s),s+=o;let t=0;for(;t<e.length&&e[t]+n.value[t]<p.value-R;)t++;let a=t;for(;a<e.length&&e[a]<p.value+T.value+R*2;)a++;return t=Math.max(0,t),a=Math.min(v.value.length-1,a),u(()=>{f()}),v.value.slice(t,a+1).map((o,g)=>({...o,id:t+g,offsetY:e[t+g]}))}),y=()=>{u(()=>{l.value&&setTimeout(()=>{l.value&&(l.value.scrollTop=l.value.scrollHeight)},10)})};let m=null;ee(()=>{if(l.value&&(T.value=l.value.clientHeight),m=new ResizeObserver(()=>{l.value&&(T.value=l.value.clientHeight),u(()=>{f()})}),l.value&&m.observe(l.value),y(),u(()=>{f()}),document.addEventListener("visibilitychange",N),se.value&&!S.value&&(S.value=!0),H.value&&(console.log(S.value),H.value)){let e={};try{const s=sessionStorage.getItem("runParams");if(s){const t=JSON.parse(s);t.menuName&&t.formData?(e=t,c(`已加载菜单【${t.menuName}】的参数，准备执行...`)):(e=t,c("已加载参数，准备执行...")),b.value="",x.value=0,$(),C(),n.value=[],p.value=0,u(()=>{if(l.value){const a=l.value.querySelector(".virtual-list-viewport");a&&(a.style.height="0px"),f()}}),pywebview.api.RunArgs(e),i.success("启动运行"),H.value=!1,A(!0)}}catch(s){c(`解析参数出错: ${s}`,"error")}}});const N=()=>{document.visibilityState==="visible"&&y()};oe(()=>{y()}),ne(()=>{m&&(l.value&&m.unobserve(l.value),m.disconnect(),m=null),document.removeEventListener("visibilitychange",N)});const J=async()=>{if(await fe()){i.warning("请先停止运行！");return}else i.success("重新运行！"),b.value="",x.value=0,$(),C(),n.value=[],p.value=0,u(()=>{if(l.value){const t=l.value.querySelector(".virtual-list-viewport");t&&(t.style.height="0px"),f()}}),c("开始执行任务...");let s={};try{const t=sessionStorage.getItem("runParams");t?(s=JSON.parse(t),c("已加载参数，准备执行...")):c("未找到参数，将使用默认设置","warning")}catch(t){c(`解析参数出错: ${t}`,"error")}try{await pywebview.api.RunArgs(s)}catch{}},C=()=>{u(()=>{l.value&&setTimeout(()=>{l.value&&(l.value.scrollTop=0,p.value=0)},10)})},Y=async()=>{try{c("用户手动停止任务","warning"),await A(!1),G(!1),i.warning("已停止运行")}catch(e){c(`停止任务出错: ${e}`,"error")}},G=async(e,s)=>{S.value=!1,b.value="exception",y()},U=()=>{$(),C(),n.value=[],p.value=0,u(()=>{if(l.value){const e=l.value.querySelector(".virtual-list-viewport");e&&(e.style.height="0px"),f()}})},F=()=>{const e=he();e.success?i.success("日志导出成功"):(i.error("日志导出失败"),console.error("导出日志失败:",e.error))},X=()=>{try{const e=sessionStorage.getItem("runParams");if(e){const s=JSON.parse(e);i.success("已保存当前参数到开机启动"),pywebview.api.SaveParamsToStartup(s)}else c("未找到可保存的参数","warning"),i.warning("未找到可保存的参数")}catch(e){c(`保存参数失败: ${e}`,"error"),i.error("保存参数失败")}},j=()=>{try{const e=sessionStorage.getItem("runParams");if(e){const s=JSON.parse(e);i.success("已保存当前参数到定时任务"),pywebview.api.SaveParamsToTimed(s)}else c("未找到可保存的参数","warning"),i.warning("未找到可保存的参数")}catch(e){c(`保存参数失败: ${e}`,"error"),i.error("保存参数失败")}},Q=e=>{const s=/(https?:\/\/[^\s]+)/g;return e.replace(s,t=>`<a href="${t}" target="_blank" class="log-link" onclick="event.stopPropagation()">${t}</a>`)},W=(e,s)=>{var a;if((a=s==null?void 0:s.target)!=null&&a.classList.contains("log-link"))return;const t=e.message;navigator.clipboard.writeText(t).then(()=>{i.success("已复制到剪贴板")}).catch(()=>{i.error("复制失败")})};return(e,s)=>{const t=re,a=ue;return P(),E("div",we,[r("div",_e,[r("div",ye,[r("div",Se,[s[4]||(s[4]=r("h2",null,"运行日志",-1)),r("div",be,[h(t,{type:"danger",size:"small",onClick:j,disabled:d(v).length===0},{default:w(()=>s[0]||(s[0]=[_(" 定时执行 ")])),_:1},8,["disabled"]),h(t,{type:"primary",size:"small",onClick:X,disabled:d(v).length===0},{default:w(()=>s[1]||(s[1]=[_(" 开机启动 ")])),_:1},8,["disabled"]),h(t,{type:"warning",size:"small",onClick:U,disabled:d(v).length===0},{default:w(()=>s[2]||(s[2]=[_(" 清空日志 ")])),_:1},8,["disabled"]),h(t,{type:"success",size:"small",onClick:F,disabled:d(v).length===0},{default:w(()=>s[3]||(s[3]=[_(" 导出日志 ")])),_:1},8,["disabled"])])]),r("div",Te,[r("div",Le,[r("div",{class:"log-content",ref_key:"logContentRef",ref:l,onScroll:D},[r("div",{class:"virtual-list-viewport",style:V({height:B.value+"px"})},[(P(!0),E(ie,null,ce(k.value,o=>(P(),E("p",{key:o.id,class:de([`log-${o.type}`,"log-line"]),onClick:g=>W(o,g),title:"点击复制",style:V({transform:`translateY(${o.offsetY}px)`})},[r("span",ke,"["+O(o.time)+"]",1),r("span",Ce,"["+O(o.type.toUpperCase())+"]",1),r("span",{class:"log-message",innerHTML:Q(o.message)},null,8,He)],14,xe))),128))],4)],544)]),s[7]||(s[7]=r("div",{class:"macos-divider"},null,-1)),r("div",$e,[h(a,{"text-inside":!0,"stroke-width":26,percentage:d(x),status:d(b)},null,8,["percentage","status"])]),r("div",Ee,[h(t,{type:"success",icon:d(ve),onClick:J,plain:""},{default:w(()=>s[5]||(s[5]=[_(" 重新运行 ")])),_:1},8,["icon"]),h(t,{type:"danger",icon:d(ge),onClick:Y,plain:""},{default:w(()=>s[6]||(s[6]=[_(" 停止运行 ")])),_:1},8,["icon"])])])])])])}}}),Me=me(Pe,[["__scopeId","data-v-9b6fae13"]]);export{Me as default};
