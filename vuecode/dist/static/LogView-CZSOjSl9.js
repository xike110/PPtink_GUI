import{l as Q,r as W,i as Z,s as H,b as i,p as ee,c as te,d as E,e as A,t as se,g as ae,f as le}from"./webdemo-CPAp8o33.js";/* empty css                    */import{M as oe,r as L,w as M,c as z,s as c,o as ne,al as u,aw as re,au as ie,b as $,x as R,e as r,d as m,f as w,A as y,u as f,C as ce,y as V,F as ue,l as ve,p as ge,t as q,ax as de,ay as pe,az as fe,_ as he}from"./zh-cn-Vbf23Fjh.js";const me={class:"macos-window"},_e={class:"content-area"},we={class:"section-container"},ye={class:"section-header"},Se={class:"header-buttons"},be={class:"section-content"},xe={class:"log-area"},Le=["onClick"],Te={class:"log-time"},ke={class:"log-level"},Ce=["innerHTML"],He={class:"progress-container"},Ee={class:"control-buttons"},O=1e3,I=24,$e=oe({__name:"LogView",setup(Re){const v=Q,S=Z,T=te,b=ee,l=L(null);M(v,t=>{t.length>O&&se(O),_()},{deep:!0});const d=L(0),x=L(0),n=L([]),N=()=>{if(v.value.length>n.value.length){const t=Array(v.value.length-n.value.length).fill(I);n.value=[...n.value,...t],c(()=>{const s=document.querySelectorAll(".log-line"),e=n.value.length-t.length;for(let a=0;a<t.length&&e+a<s.length;a++){const o=s[e+a];o&&(n.value[e+a]=o.offsetHeight)}})}};M(v,()=>{N()},{immediate:!0});const B=z(()=>(N(),n.value.reduce((t,s)=>t+s,0))),D=t=>{l.value&&(d.value=l.value.scrollTop,x.value=l.value.clientHeight,c(()=>{p()}))},p=()=>{const t=document.querySelectorAll(".log-line");if(t.length===0)return;let s=!1;k.value.forEach(e=>{const a=e.id,o=t[e.id-k.value[0].id];if(o&&a<n.value.length){const g=o.offsetHeight;g>0&&g!==n.value[a]&&(n.value[a]=g,s=!0)}}),s&&c(()=>{const e=n.value.reduce((a,o)=>a+o,0);if(l.value){const a=l.value.querySelector(".virtual-list-viewport");a&&(a.style.height=`${e}px`)}})},k=z(()=>{if(!l.value)return[];const t=[];let s=0;for(const o of n.value)t.push(s),s+=o;let e=0;for(;e<t.length&&t[e]+n.value[e]<d.value-I;)e++;let a=e;for(;a<t.length&&t[a]<d.value+x.value+I*2;)a++;return e=Math.max(0,e),a=Math.min(v.value.length-1,a),c(()=>{p()}),v.value.slice(e,a+1).map((o,g)=>({...o,id:e+g,offsetY:t[e+g]}))}),_=()=>{c(()=>{l.value&&setTimeout(()=>{l.value&&(l.value.scrollTop=l.value.scrollHeight)},10)})};let h=null;ne(()=>{if(l.value&&(x.value=l.value.clientHeight),h=new ResizeObserver(()=>{l.value&&(x.value=l.value.clientHeight),c(()=>{p()})}),l.value&&h.observe(l.value),_(),c(()=>{p()}),document.addEventListener("visibilitychange",P),W.value&&!S.value&&(S.value=!0),H.value&&(console.log(S.value),H.value)){let t={};try{const s=sessionStorage.getItem("runParams");if(s){const e=JSON.parse(s);e.menuName&&e.formData?(t=e,i(`已加载菜单【${e.menuName}】的参数，准备执行...`)):(t=e,i("已加载参数，准备执行...")),b.value="",T.value=0,E(),C(),n.value=[],d.value=0,c(()=>{if(l.value){const a=l.value.querySelector(".virtual-list-viewport");a&&(a.style.height="0px"),p()}}),pywebview.api.RunArgs(t),u.success("启动运行"),H.value=!1,A(!0)}}catch(s){i(`解析参数出错: ${s}`,"error")}}});const P=()=>{document.visibilityState==="visible"&&_()};re(()=>{_()}),ie(()=>{h&&(l.value&&h.unobserve(l.value),h.disconnect(),h=null),document.removeEventListener("visibilitychange",P)});const J=async()=>{if(await ae()){u.warning("请先停止运行！");return}else u.success("重新运行！"),b.value="",T.value=0,E(),C(),n.value=[],d.value=0,c(()=>{if(l.value){const e=l.value.querySelector(".virtual-list-viewport");e&&(e.style.height="0px"),p()}}),i("开始执行任务...");let s={};try{const e=sessionStorage.getItem("runParams");e?(s=JSON.parse(e),i("已加载参数，准备执行...")):i("未找到参数，将使用默认设置","warning")}catch(e){i(`解析参数出错: ${e}`,"error")}try{await pywebview.api.RunArgs(s)}catch{}},C=()=>{c(()=>{l.value&&setTimeout(()=>{l.value&&(l.value.scrollTop=0,d.value=0)},10)})},Y=async()=>{try{i("用户手动停止任务","warning"),await A(!1),F(!1),u.warning("已停止运行")}catch(t){i(`停止任务出错: ${t}`,"error")}},F=async(t,s)=>{S.value=!1,b.value="exception",_()},G=()=>{E(),C(),n.value=[],d.value=0,c(()=>{if(l.value){const t=l.value.querySelector(".virtual-list-viewport");t&&(t.style.height="0px"),p()}})},U=()=>{const t=le();t.success?u.success("日志导出成功"):(u.error("日志导出失败"),console.error("导出日志失败:",t.error))},X=()=>{try{const t=sessionStorage.getItem("runParams");if(t){const s=JSON.parse(t);u.success("已保存当前参数到开机启动"),pywebview.api.SaveParamsToStartup(s)}else i("未找到可保存的参数","warning"),u.warning("未找到可保存的参数")}catch(t){i(`保存参数失败: ${t}`,"error"),u.error("保存参数失败")}},j=t=>{const s=/(https?:\/\/[^\s]+)/g;return t.replace(s,e=>`<a href="${e}" target="_blank" class="log-link" onclick="event.stopPropagation()">${e}</a>`)},K=(t,s)=>{var a;if((a=s==null?void 0:s.target)!=null&&a.classList.contains("log-link"))return;const e=t.message;navigator.clipboard.writeText(e).then(()=>{u.success("已复制到剪贴板")}).catch(()=>{u.error("复制失败")})};return(t,s)=>{const e=ce,a=de;return R(),$("div",me,[r("div",_e,[r("div",we,[r("div",ye,[s[3]||(s[3]=r("h2",null,"运行日志",-1)),r("div",Se,[m(e,{type:"primary",size:"small",onClick:X,disabled:f(v).length===0},{default:w(()=>s[0]||(s[0]=[y(" 开机启动 ")])),_:1},8,["disabled"]),m(e,{type:"warning",size:"small",onClick:G,disabled:f(v).length===0},{default:w(()=>s[1]||(s[1]=[y(" 清空日志 ")])),_:1},8,["disabled"]),m(e,{type:"success",size:"small",onClick:U,disabled:f(v).length===0},{default:w(()=>s[2]||(s[2]=[y(" 导出日志 ")])),_:1},8,["disabled"])])]),r("div",be,[r("div",xe,[r("div",{class:"log-content",ref_key:"logContentRef",ref:l,onScroll:D},[r("div",{class:"virtual-list-viewport",style:V({height:B.value+"px"})},[(R(!0),$(ue,null,ve(k.value,o=>(R(),$("p",{key:o.id,class:ge([`log-${o.type}`,"log-line"]),onClick:g=>K(o,g),title:"点击复制",style:V({transform:`translateY(${o.offsetY}px)`})},[r("span",Te,"["+q(o.time)+"]",1),r("span",ke,"["+q(o.type.toUpperCase())+"]",1),r("span",{class:"log-message",innerHTML:j(o.message)},null,8,Ce)],14,Le))),128))],4)],544)]),s[6]||(s[6]=r("div",{class:"macos-divider"},null,-1)),r("div",He,[m(a,{"text-inside":!0,"stroke-width":26,percentage:f(T),status:f(b)},null,8,["percentage","status"])]),r("div",Ee,[m(e,{type:"success",icon:f(pe),onClick:J,plain:""},{default:w(()=>s[4]||(s[4]=[y(" 重新运行 ")])),_:1},8,["icon"]),m(e,{type:"danger",icon:f(fe),onClick:Y,plain:""},{default:w(()=>s[5]||(s[5]=[y(" 停止运行 ")])),_:1},8,["icon"])])])])])])}}}),Ae=he($e,[["__scopeId","data-v-757c116e"]]);export{Ae as default};
