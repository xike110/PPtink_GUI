import{R as Q,r as b,w as A,D as V,T as W,N as r,o as Z,G as K,U as ee,Q as C,V as c,W as te,X as se,Y as E,M as g,Z as P,$ as ae,I as le,c as $,d as i,g as _,h as L,S as f,j as oe,L as q,F as ne,k as ie,a0 as re,a1 as ce,a2 as ue,i as x,s as ve,t as z,b as R,a3 as ge,H as de,a4 as pe,_ as he}from"./webdemo-CBVBTN4-.js";/* empty css                    */const fe={class:"macos-window"},me={class:"content-area"},_e={class:"section-container"},we={class:"section-header"},ye={class:"header-buttons"},Se={class:"section-content"},be={class:"log-area"},Le=["onClick"],xe={class:"log-time"},ke={class:"log-level"},Te=["innerHTML"],He={class:"progress-container"},Ce={class:"control-buttons"},B=1e3,I=24,Ee=Q({__name:"LogView",setup($e){const u=W,w=ee,k=se,y=te,l=b(null);A(u,s=>{s.length>B&&ge(B),m()},{deep:!0});const d=b(0),S=b(0),n=b([]),N=()=>{if(u.value.length>n.value.length){const s=Array(u.value.length-n.value.length).fill(I);n.value=[...n.value,...s],r(()=>{const t=document.querySelectorAll(".log-line"),e=n.value.length-s.length;for(let a=0;a<s.length&&e+a<t.length;a++){const o=t[e+a];o&&(n.value[e+a]=o.offsetHeight)}})}};A(u,()=>{N()},{immediate:!0});const O=V(()=>(N(),n.value.reduce((s,t)=>s+t,0))),D=s=>{l.value&&(d.value=l.value.scrollTop,S.value=l.value.clientHeight,r(()=>{p()}))},p=()=>{const s=document.querySelectorAll(".log-line");if(s.length===0)return;let t=!1;T.value.forEach(e=>{const a=e.id,o=s[e.id-T.value[0].id];if(o&&a<n.value.length){const v=o.offsetHeight;v>0&&v!==n.value[a]&&(n.value[a]=v,t=!0)}}),t&&r(()=>{const e=n.value.reduce((a,o)=>a+o,0);if(l.value){const a=l.value.querySelector(".virtual-list-viewport");a&&(a.style.height=`${e}px`)}})},T=V(()=>{if(!l.value)return[];const s=[];let t=0;for(const o of n.value)s.push(t),t+=o;let e=0;for(;e<s.length&&s[e]+n.value[e]<d.value-I;)e++;let a=e;for(;a<s.length&&s[a]<d.value+S.value+I*2;)a++;return e=Math.max(0,e),a=Math.min(u.value.length-1,a),r(()=>{p()}),u.value.slice(e,a+1).map((o,v)=>({...o,id:e+v,offsetY:s[e+v]}))}),m=()=>{r(()=>{l.value&&setTimeout(()=>{l.value&&(l.value.scrollTop=l.value.scrollHeight)},10)})};let h=null;Z(()=>{if(l.value&&(S.value=l.value.clientHeight),h=new ResizeObserver(()=>{l.value&&(S.value=l.value.clientHeight),r(()=>{p()})}),l.value&&h.observe(l.value),m(),r(()=>{p()}),document.addEventListener("visibilitychange",M),K.value&&!w.value&&(w.value=!0),C.value&&(console.log(w.value),C.value)){let s={};try{const t=sessionStorage.getItem("runParams");if(t){const e=JSON.parse(t);e.menuName&&e.formData?(s=e,c(`已加载菜单【${e.menuName}】的参数，准备执行...`)):(s=e,c("已加载参数，准备执行...")),y.value="",k.value=0,E(),H(),n.value=[],d.value=0,r(()=>{if(l.value){const a=l.value.querySelector(".virtual-list-viewport");a&&(a.style.height="0px"),p()}}),pywebview.api.RunArgs(s),g.success("启动运行"),C.value=!1,P(!0)}}catch(t){c(`解析参数出错: ${t}`,"error")}}});const M=()=>{document.visibilityState==="visible"&&m()};ae(()=>{m()}),le(()=>{h&&(l.value&&h.unobserve(l.value),h.disconnect(),h=null),document.removeEventListener("visibilitychange",M)});const Y=async()=>{if(await de()){g.warning("请先停止运行！");return}else g.success("重新运行！"),y.value="",k.value=0,E(),H(),n.value=[],d.value=0,r(()=>{if(l.value){const e=l.value.querySelector(".virtual-list-viewport");e&&(e.style.height="0px"),p()}}),c("开始执行任务...");let t={};try{const e=sessionStorage.getItem("runParams");e?(t=JSON.parse(e),c("已加载参数，准备执行...")):c("未找到参数，将使用默认设置","warning")}catch(e){c(`解析参数出错: ${e}`,"error")}try{await pywebview.api.RunArgs(t)}catch{}},H=()=>{r(()=>{l.value&&setTimeout(()=>{l.value&&(l.value.scrollTop=0,d.value=0)},10)})},G=async()=>{try{c("用户手动停止任务","warning"),await P(!1),U(!1),g.warning("已停止运行")}catch(s){c(`停止任务出错: ${s}`,"error")}},U=async(s,t)=>{w.value=!1,y.value="exception",m()},F=()=>{E(),H(),n.value=[],d.value=0,r(()=>{if(l.value){const s=l.value.querySelector(".virtual-list-viewport");s&&(s.style.height="0px"),p()}})},J=()=>{const s=pe();s.success?g.success("日志导出成功"):(g.error("日志导出失败"),console.error("导出日志失败:",s.error))},X=s=>{const t=/(https?:\/\/[^\s]+)/g;return s.replace(t,e=>`<a href="${e}" target="_blank" class="log-link" onclick="event.stopPropagation()">${e}</a>`)},j=(s,t)=>{var a;if((a=t==null?void 0:t.target)!=null&&a.classList.contains("log-link"))return;const e=s.message;navigator.clipboard.writeText(e).then(()=>{g.success("已复制到剪贴板")}).catch(()=>{g.error("复制失败")})};return(s,t)=>{const e=oe,a=re;return R(),$("div",fe,[i("div",me,[i("div",_e,[i("div",we,[t[2]||(t[2]=i("h2",null,"运行日志",-1)),i("div",ye,[_(e,{type:"warning",size:"small",onClick:F,disabled:f(u).length===0},{default:L(()=>t[0]||(t[0]=[x(" 清空日志 ")])),_:1},8,["disabled"]),_(e,{type:"success",size:"small",onClick:J,disabled:f(u).length===0},{default:L(()=>t[1]||(t[1]=[x(" 导出日志 ")])),_:1},8,["disabled"])])]),i("div",Se,[i("div",be,[i("div",{class:"log-content",ref_key:"logContentRef",ref:l,onScroll:D},[i("div",{class:"virtual-list-viewport",style:q({height:O.value+"px"})},[(R(!0),$(ne,null,ie(T.value,o=>(R(),$("p",{key:o.id,class:ve([`log-${o.type}`,"log-line"]),onClick:v=>j(o,v),title:"点击复制",style:q({transform:`translateY(${o.offsetY}px)`})},[i("span",xe,"["+z(o.time)+"]",1),i("span",ke,"["+z(o.type.toUpperCase())+"]",1),i("span",{class:"log-message",innerHTML:X(o.message)},null,8,Te)],14,Le))),128))],4)],544)]),t[5]||(t[5]=i("div",{class:"macos-divider"},null,-1)),i("div",He,[_(a,{"text-inside":!0,"stroke-width":26,percentage:f(k),status:f(y)},null,8,["percentage","status"])]),i("div",Ce,[_(e,{type:"success",icon:f(ce),onClick:Y,plain:""},{default:L(()=>t[3]||(t[3]=[x(" 重新运行 ")])),_:1},8,["icon"]),_(e,{type:"danger",icon:f(ue),onClick:G,plain:""},{default:L(()=>t[4]||(t[4]=[x(" 停止运行 ")])),_:1},8,["icon"])])])])])])}}}),Ne=he(Ee,[["__scopeId","data-v-604adcac"]]);export{Ne as default};
